<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600|Open+Sans:400,600,700" rel="stylesheet">
    <link rel="stylesheet" href="css/spur.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.12.4/sweetalert2.min.css" integrity="sha512-WxRv0maH8aN6vNOcgNFlimjOhKp+CUqqNougXbz0E+D24gP5i+7W/gcc5tenxVmr28rH85XHF5eXehpV2TQhRg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.12.4/sweetalert2.min.js" integrity="sha512-w4LAuDSf1hC+8OvGX+CKTcXpW4rQdfmdD8prHuprvKv3MPhXH9LonXX9N2y1WEl2u3ZuUSumlNYHOlxkS/XEHA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>CMS-DASHBOARD</title>
</head>

<body>
    <div class="dash" id="app">
        <div class="dash-nav dash-nav-dark">
            <header>
                <a href="#" class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </a>
                <a href="index.html" class="spur-logo"><i class="fas fa-trophy"></i> <span>CMS</span></a>
            </header>
            <nav class="dash-nav-list">
                <a href="index.html" class="dash-nav-item">
                    <i class="fas fa-home"></i> 仪表盘 </a>
                <div class="dash-nav-dropdown">
                    <a href="#!" class="dash-nav-item dash-nav-dropdown-toggle">
                        <i class="fas fa-plus"></i> 添加信息 </a>

                    <div class="dash-nav-dropdown-menu">
                        <a href="competition-result.html" class="dash-nav-dropdown-item">新增竞赛成果</a>
                    </div>
                    <div class="dash-nav-dropdown-menu">
                        <a href="competition-name.html" class="dash-nav-dropdown-item">新增竞赛条目</a>
                    </div>
                    <div class="dash-nav-dropdown-menu">
                        <a href="major-name.html" class="dash-nav-dropdown-item">新增专业条目</a>
                    </div>
                    <div class="dash-nav-dropdown-menu">
                        <a href="faculty-name.html" class="dash-nav-dropdown-item">新增学院条目</a>
                    </div>
                </div>
                <a href="query-competition-results.html" class="dash-nav-item">
                    <i class="fas fa-search"></i> 查询记录 </a>
            </nav>
        </div>
        <div class="dash-app">
            <header class="dash-toolbar">
                <a href="#!" class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </a>
                <div class="tools">
                    <div class="dropdown tools-item">
                        <a href="#" class="" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-user"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu1">
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <a class="dropdown-item" href="../login.html">登出</a>
                        </div>
                    </div>
                </div>
            </header>
            <main class="dash-content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="card spur-card">
                                <div class="card-header">
                                    <div class="spur-card-icon">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="spur-card-title">添加学生竞赛成果</div>
                                </div>
                                <div class="card-body ">
                                    <form method="POST">
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label>学生名称</label>
                                                <input type="text" class="form-control" placeholder="输入学生名称" required v-model="studentName">
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label>学生学号</label>
                                                <input type="text" class="form-control" placeholder="输入学生学号" required v-model="studentNumber">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="selectMajor">选择专业</label>
                                            <select class="form-control selectpicker" data-live-search="true" id="selectMajor" required v-model="majorName">
                                                <option v-for="item in majorNamesList" :value="item.majorName">{{item.majorName}}</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="selectSchool">选择学院</label>
                                            <select class="form-control selectpicker" data-live-search="true" id="selectSchool" required v-model="facultyName">
                                                <option v-for="item in facultyNamesList" :value="item.facultyName" >{{item.facultyName}}</option>
                                            </select>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label for="inputGroup">组别</label>
                                                <input type="text" class="form-control" id="inputGroup" placeholder="输入组别" v-model="groupName">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="inputTitle">作品名称</label>
                                                <input type="text" class="form-control" id="inputTitle" placeholder="输入奖项" v-model="title">
                                            </div>
                                            <div class="form-group col-md-2">
                                                <label for="inputGrade">年级</label>
                                                <input type="text" class="form-control" id="inputGrade" placeholder="输入年级" v-model="grade">
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-4">
                                                <label for="inputMentor">指导老师</label>
                                                <input type="text" class="form-control" id="inputMentor" placeholder="输入指导老师名称" v-model="mentor">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="inputAwardLevel">获奖等级</label>
                                                <input type="text" class="form-control" id="inputAwardLevel" placeholder="输入获奖等级" v-model="prize">
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="inputLevel">竞赛级别</label>
                                                <input type="text" class="form-control" id="inputLevel" placeholder="输入竞赛级别" v-model="competitionLevel">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="selectSchool">具体竞赛名称</label>
                                            <select class="form-control selectpicker" data-live-search="true" id="selectSchool" v-model="competitionName">
                                                <option v-for="item in competitionNamesList" :value="item.competitionName">{{item.competitionName}}</option>
                                            </select>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-3">
                                                <label>业绩在学校</label>
                                                <select class="form-control" id="selectPerformance" v-model="inFaculty">
                                                    <option value="true">Yes</option>
                                                    <option value="false">No</option>
                                                </select>
                                            </div>
                                            <div class="form-group col-md-3">
                                                <label>年份</label>
                                                <input type="text" class="form-control" placeholder="输入年份" v-model="year">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary " @click.prevent="confirmAdd" style="margin-right : 150px;">提交</button>
                                        <label for="fileinp" id="upload-file">
                                            <input type="button" class="upload-btn" value="Excel导入"><span style="color:red" v-if="excelFile === null">请上传Excel文件</span> <span style="color:red" v-else>{{excelFile.name}}</span>
                                            <input type="file" @change="handleExcelFileUpload" id="fileinp" style=" width: 150px; /* 设置宽度 */height: 30px; /* 设置高度 */padding: 5px; /* 设置内边距 */font-size: 14px; /* 设置字体大小 */cursor: pointer;margin-left: 10px; /* 设置与其他元素的间距 */">
                                        </label>
                                        <button type="button" class="upload-btn" @click="confirmUpload()">上传</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="page-overlay" v-if="loading">
                    <div class="loader" v-if="loading">
                        <div id="ld3">
                            <div>
                            </div>
                            <div>
                            </div>
                            <div>
                            </div>
                            <div>
                            </div>
                        </div>
                        <p class="loader-text">表格数据解析中，请稍等</p>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="js/spur.js"></script>
    <script src="/dashboard/js/vue3.js"></script>
    <script>
        const{createApp} = Vue;

        createApp({
            data(){
                return{
                    baseurl:"/add-info/competition-result",
                    facultyNamesList : [],
                    majorNamesList : [],
                    competitionNamesList : [],
                    loading: false,
                    uploaded: null,
                    excelFile:null,
                    studentName : '',
                    studentNumber : '',
                    majorName : '',
                    facultyName : '',
                    groupName : '',
                    title : '',
                    grade : '',
                    mentor : '',
                    prize : '',
                    competitionLevel : '',
                    competitionName : '',
                    inFaculty : true,
                    year : ''
                }
            },
            methods:{
                getFacultyNamesList() {
                    fetch("/add-info/faculty-name", {method:'GET'})
                        .then(res => res.json())
                        .then(res => {
                            if(res.code === 1) this.facultyNamesList = res.data;
                            }
                        )
                },

                getMajorNamesList() {
                    fetch("/add-info/major-name", {method:'GET'})
                        .then(res => res.json())
                        .then(res => {
                            if(res.code === 1) this.majorNamesList = res.data;
                        })
                },

                getCompetitionNamesList() {
                    fetch("/add-info/competition-name", {method:'GET'})
                        .then(res => res.json())
                        .then(res => {
                            if(res.code === 1) this.competitionNamesList = res.data;
                        })
                },

                confirmAdd() {
                    Swal.fire({
                        type: 'warning', // 弹框类型
                        title: '您确定添加以下竞赛信息吗？', //标题
                        text: this.competitionName, //显示内容

                        confirmButtonColor: '#3085d6',// 确定按钮的 颜色
                        confirmButtonText: '确定',// 确定按钮的 文字
                        showCancelButton: true, // 是否显示取消按钮
                        cancelButtonColor: '#d33', // 取消按钮的 颜色
                        cancelButtonText: "取消", // 取消按钮的 文字

                        focusCancel: false, // 是否聚焦 取消按钮
                        reverseButtons: false // 是否 反转 两个按钮的位置 默认是  左边 确定  右边 取消
                    }).then((isConfirm) => {
                        //判断 是否 点击的 确定按钮
                        if (isConfirm.value) {
                            this.addCompetitionResult();
                        }

                    })
                        .catch(e => {
                            alert(e);
                        })
                },
                addCompetitionResult() {
                    let data = {
                        studentName : this.studentName,
                        studentNumber : this.studentNumber,
                        majorName : this.majorName,
                        facultyName : this.facultyName,
                        groupName : this.groupName,
                        title : this.title,
                        grade : this.grade,
                        mentor : this.mentor,
                        prize : this.prize,
                        competitionLevel : this.competitionLevel,
                        competitionName : this.competitionName,
                        inFaculty : this.inFaculty,
                        year : this.year
                    }
                    fetch(this.baseurl + "/add", {
                        method:'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    })
                        .then(res => res.json())
                        .then(res => {
                            if(res.code === 1) Swal("添加成功", "", "success");
                            else Swal("添加失败", "请检查数据是否重复或其他不合理", "error")
                        })
                        .catch(error => {
                            Swal("添加失败", "", "error")
                        })
                },
                confirmUpload(){
                    if (!this.excelFile) {
                        Swal.fire("请先选择文件！");
                        return;
                    }
                    const fileName = this.excelFile.name.toLowerCase();
                    if (!fileName.endsWith(".xls") && !fileName.endsWith(".xlsx")) {
                        Swal.fire("请选择一个有效的Excel文件！");
                        return;
                    }
                    Swal.fire({
                        type: 'warning', // 弹框类型
                        title: '您确定上传该文件吗？', //标题
                        text: this.competitionName, //显示内容

                        confirmButtonColor: '#3085d6',// 确定按钮的 颜色
                        confirmButtonText: '确定',// 确定按钮的 文字
                        showCancelButton: true, // 是否显示取消按钮
                        cancelButtonColor: '#d33', // 取消按钮的 颜色
                        cancelButtonText: "重新选择", // 取消按钮的 文字

                        focusCancel: false, // 是否聚焦 取消按钮
                        reverseButtons: false // 是否 反转 两个按钮的位置 默认是  左边 确定  右边 取消
                    }).then((isConfirm) => {
                        //判断 是否 点击的 确定按钮
                        if (isConfirm.value) {
                            this.uploadExcelFile();
                            this.excelFile = null;
                        }

                    })
                        .catch(e => {
                            alert(e);
                        })
                },
                // 处理文件选择
                handleExcelFileUpload(event) {
                    this.excelFile = event.target.files[0]; // 获取选中的文件

                },
                // 上传文件
                uploadExcelFile() {
                    const formData = new FormData();
                    formData.append("excelFile", this.excelFile); // 将文件添加到 FormData 中
                    this.loading = true;

                    // 发送 POST 请求到后端
                    fetch(this.baseurl + "/upload", {
                        method:'POST',
                        body:formData,
                    })
                        .then(res => {
                            this.loading = false;
                            return res.json();
                        })
                        .then(res => {
                            if(res.code === 1){
                                this.updateListByExcel(formData);
                                Swal.fire("文件导入成功", "", "success");
                            }
                            else{
                                Swal.fire("文件导入失败1", "", "error");
                            }
                        })
                        .catch(error => {
                            Swal.fire("文件导入失败2", "", "error");
                        });
                },
                updateListByExcel(formData) {
                    console.log("启动了");
                    // 发送 POST 请求到后端
                    fetch(this.baseurl + "/update-list", {
                        method:'POST',
                        body:formData,
                    })
                        .catch(error =>{
                            Swal("列表数据更新失败", "", "error");
                        })
                },
            },
            async created(){
                this.getFacultyNamesList();
                this.getMajorNamesList();
                this.getCompetitionNamesList();
            }
        }).mount("#app")
    </script>
</body>

</html>
